
%Thrust Profile Estes A8-3 taken from 
%https://www.thrustcurve.org/simfiles/5f4294d20002e900000004e3/

%Finding Thrust values based on interpolation
[tT,T] = RocketProjectThrustCurve;

% Rocket Design inputs
A = 5.0*10^-4;
Cd = .1;
CdChute = 1.3;
mRocket = 40; %g
mSand = 0; %g
m = (mRocket + mSand)/1000; %kg
theta = 1; %deg, launch angle, measured from the vertical
railLength = 2; %length of rail the rocket will launch from - assuming 2ft
deltaT = 0.001;
delayCharge = 3;
g = 9.81;

%initial conditions
vWind = 0; %check on day of launch
    %Start at rest
    x(1) = 0;
    y(1) = 0;
    s(1) = 0;
    Vx(1) = 0;
    Vy(1) = 0;
    t = 0;
n = 1;

PRESCOTT_ELEVATION = 5367; %ft
[Temp, a, P, rho] = atmosisa(PRESCOTT_ELEVATION * 0.3048);

%TODO: Implement Thrust (F) and relative velocity (Vrel)
%while y(n) >= 0

%initial velocity loop
while Vy(n) <= 0 || s(n) <= railLength
    V = sqrt(Vx(n)^2 + Vy(n)^2);
    if Vy(n) <= 0
        x(n+1) = 0;
        y(n+1) = 0;
        s(n+1) = 0;
    else
        s(n+1) = s(n) + deltaT * sqrt((V*cosd(theta))^2 + (V*sind(theta)^2)); 
        x(n+1) = s(n+1)*sind(theta);
        y(n+1) = s(n+1)*cosd(theta);
    end
    
    %Drag = 0
    %Thrust Components
    Tx = T(n) * sind(theta);
    Ty = T(n) * cosd(theta);

    Vx(n+1) = Vx(n) + deltaT * (Tx/m);
    Vy(n+1) = Vy(n) + deltaT * (- g + Ty/m);
    t(n+1) = t(n) + deltaT;

    n = n+1;
    if n>length(T)
        fprintf("Vehicle too heavy to liftoff with A8-3 motor");
        break
    end
end

fprintf("Velocity off the rail is %.2f, Vx = %.2f, Vy = %.2f\n", V, Vx(n), Vy(n))
fprintf("n = %.0f\n", n)

%Main trajectory loop rocket off the rail, direction based on orientation determined from speed
while n <= 20000
    if n <= length(T)    % Boost
        x(n+1) = x(n) + Vx(n)*deltaT;
        y(n+1) = y(n) + Vy(n)*deltaT;
        V = sqrt(Vx(n)^2 + Vy(n)^2);
   
        %Drag due to rocket
        FD = 0.5 * rho * A * V^2 * Cd;
        FDx = FD*Vx(n)/V;
        FDy = FD*Vy(n)/V;

        %Thrust Components
        Tx = T(n) * Vx(n)/V;
        Ty = T(n) * Vy(n)/V;

        %Positioning
        Vx(n+1) = Vx(n) + deltaT * (-FDx/m + Tx/m);
        Vy(n+1) = Vy(n) + deltaT * (-FDy/m - g + Ty/m);
        t = t + deltaT;
%{
    elseif t >= delayCharge  %chute deployed
        x(n+1) = x(n) + Vx(n)*deltaT;
        y(n+1) = y(n) + Vy(n)*deltaT;
        V = sqrt(Vx(n)^2 + Vy(n)^2);
        
        %Drag due to rocket
        FD = 0.5*rho*A*V^2*CD;
        FDx = FD*Vx(n)/V;
        FDy = FD*Vy(n)/V;
        
        %Drag due to chute
        FD = FD + 0.5 * rho * A * V^2 * CD;
        FDx = FDx + FD * Vx(n)/V;
        FDy = FDy + FD * Vy(n)/V;
 
        %Positioning
        Vx(n+1)=Vx(n) + deltaT*-(FDx)/m;
        Vy(n+1) = Vy(n) + deltaT*(-FDy/m-g);
        t(n+1)=t(n) + deltaT;
        fprintf("Chute\n")
%}
    else        % Burnout
        x(n+1) = x(n) + Vx(n)*deltaT;
        y(n+1) = y(n) + Vy(n)*deltaT;
        V = sqrt(Vx(n)^2 + Vy(n)^2);
        
        %Drag due to rocket
        FD = 0.5*rho*A*V^2*Cd;
        FDx = FD*Vx(n)/V;
        FDy = FD*Vy(n)/V;
        
        %Positioning
        Vx(n+1) = Vx(n) + deltaT*(-FDx/m);
        Vy(n+1) = Vy(n) + deltaT*(-FDy/m - g);
        t = t + deltaT;
    end
    
    

    if y(n+1) <= 0
        fprintf("%f\n",y(n+1))
        break
    end

    n=n+1;
end

hold off
plot(x,y)
xlabel("Distance (m)")
ylabel("Height (m)")
Title("Rocket Trajectory")

fprintf("\nTotal flight time = %.3f\n", t);
fprintf("Apogee = %.3f\n", nan);
fprintf("Ground hit velocity is ")
